---
import { MessageSquare, X, Send, Bot, User, Terminal, ChevronRight, Minimize2, Maximize2, Cpu } from "lucide-react";

const BACKEND_API_URL = import.meta.env.PUBLIC_BACKEND_API_URL;
---

<!-- Floating Trigger Button -->
<button
  id="ai-trigger"
  class="fixed bottom-6 right-6 z-50 p-4 rounded-full shadow-[0_0_30px_rgba(16,185,129,0.4)] transition-all duration-300 bg-black border border-emerald-500/50 text-emerald-400 hover:scale-110 hover:rotate-6"
  aria-label="Open AI Assistant"
>
  <div class="absolute inset-0 rounded-full bg-emerald-500/20 animate-ping"></div>
  <Cpu size={28} class="relative z-10" />
</button>

<!-- Chat Interface -->
<div
  id="ai-chat"
  class="fixed bottom-6 right-6 z-50 bg-black/90 backdrop-blur-xl border border-emerald-500/30 rounded-lg shadow-[0_0_50px_rgba(16,185,129,0.15)] flex-col overflow-hidden font-mono hidden"
  style="width: min(90vw, 400px); height: 500px;"
  data-api-url={BACKEND_API_URL}
>
  <!-- Header -->
  <div 
    id="chat-header"
    class="p-3 bg-emerald-950/30 border-b border-emerald-500/20 flex justify-between items-center cursor-pointer"
  >
    <div class="flex items-center gap-2 text-emerald-400">
      <Terminal size={16} />
      <span class="text-xs font-bold tracking-widest">NEURAL_LINK_V2</span>
      <span class="flex h-2 w-2 relative">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
      </span>
    </div>
    <div class="flex items-center gap-2">
      <button 
        id="minimize-btn"
        class="text-emerald-500/50 hover:text-emerald-400 p-1"
        aria-label="Minimize Chat"
      >
        <Minimize2 size={14} />
      </button>
      <button 
        id="close-btn"
        class="text-emerald-500/50 hover:text-red-400 p-1 transition-colors"
        aria-label="Close Chat"
      >
        <X size={16} />
      </button>
    </div>
  </div>

  <!-- Messages Area -->
  <div 
    id="messages-container" 
    class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-emerald-900/50 scrollbar-track-transparent"
  >
    <!-- Initial message will be added via JS -->
  </div>

  <!-- Input Area -->
  <div class="p-3 bg-black/40 border-t border-emerald-500/20">
    <div class="flex gap-2 relative">
      <div class="absolute left-3 top-1/2 -translate-y-1/2 text-emerald-500/50">
        <ChevronRight size={14} />
      </div>
      <input
        id="chat-input"
        type="text"
        placeholder="Enter command..."
        class="flex-1 bg-emerald-950/10 border border-emerald-500/20 rounded pl-8 pr-4 py-2.5 text-sm text-emerald-100 placeholder-emerald-700/30 focus:outline-none focus:border-emerald-500/50 focus:bg-emerald-950/20 transition-all font-mono"
      />
      <button
        id="send-btn"
        class="p-2.5 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded hover:bg-emerald-500/20 hover:shadow-[0_0_10px_rgba(16,185,129,0.2)] disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        aria-label="Send Message"
      >
        <Send size={16} />
      </button>
    </div>
  </div>
</div>

<style is:global>
  /* Chat animations */
  #ai-chat {
    transform: translateY(100px) scale(0.9);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  #ai-chat.open {
    display: flex !important;
    transform: translateY(0) scale(1);
    opacity: 1;
  }

  #ai-chat.minimized {
    height: 60px !important;
    width: 300px !important;
  }

  #ai-chat.minimized #messages-container,
  #ai-chat.minimized .p-3.bg-black\/40 {
    display: none;
  }

  /* Trigger button hide when chat open */
  #ai-trigger.hidden {
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
  }

  /* Message animations */
  .message {
    animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .typing-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #10b981 !important; /* Emerald 500 */
    border-radius: 50%;
    animation: typing 1.4s infinite;
  }

  .typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 60%, 100% {
      opacity: 0.3;
      transform: scale(0.8);
    }
    30% {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Scrollbar styling */
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(5, 150, 105, 0.5);
    border-radius: 3px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(5, 150, 105, 0.7);
  }

  /* Spin animation for CPU icon */
  @keyframes spin-slow {
    to {
      transform: rotate(360deg);
    }
  }

  #ai-trigger:hover .relative {
    animation: spin-slow 2s linear infinite;
  }

  /* Pulse delays */
  .delay-75 {
    animation-delay: 75ms;
  }

  .delay-150 {
    animation-delay: 150ms;
  }
</style>

<script>
  // State
  let isOpen = false;
  let isMinimized = false;
  let isProcessing = false;
  let messages: any[] = [];

  // DOM Elements
  const trigger = document.getElementById('ai-trigger');
  const chatBox = document.getElementById('ai-chat');
  const closeBtn = document.getElementById('close-btn');
  const minimizeBtn = document.getElementById('minimize-btn');
  const messagesContainer = document.getElementById('messages-container');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const sendBtn = document.getElementById('send-btn');
  const chatHeader = document.getElementById('chat-header');

  // Typewriter effect
  class Typewriter {
    element: HTMLElement;
    text: string;
    speed: number;
    index: number;
    
    constructor(element: HTMLElement, text: string, speed = 20) {
      this.element = element;
      this.text = text;
      this.speed = speed;
      this.index = 0;
      this.type();
    }

    type() {
      if (this.index < this.text.length) {
        this.element.textContent += this.text.charAt(this.index);
        this.index++;
        setTimeout(() => this.type(), this.speed);
      }
    }
  }

  // Create message element
  function createMessageElement(msg: any): HTMLElement {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message flex gap-3 ${msg.type === 'user' ? 'flex-row-reverse' : ''}`;
    
    const iconDiv = document.createElement('div');
    iconDiv.className = `w-8 h-8 rounded flex items-center justify-center shrink-0 border ${
      msg.type === 'user' 
        ? 'bg-blue-950/30 border-blue-500/30 text-blue-400' 
        : 'bg-emerald-950/30 border-emerald-500/30 text-emerald-400'
    }`;
    iconDiv.innerHTML = msg.type === 'user' 
      ? '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
      : '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'flex flex-col gap-2 max-w-[80%]';

    const textDiv = document.createElement('div');
    textDiv.className = `p-3 rounded text-sm border backdrop-blur-sm ${
      msg.type === 'user' 
        ? 'bg-blue-900/10 text-blue-100 border-blue-500/20 rounded-tr-none' 
        : 'bg-emerald-900/10 text-emerald-100 border-emerald-500/20 rounded-tl-none'
    }`;

    const textContent = document.createElement('p');
    textContent.className = 'whitespace-pre-wrap leading-relaxed';
    
    if (msg.type === 'bot' && msg.isTyping) {
      new Typewriter(textContent, msg.text);
    } else {
      textContent.textContent = msg.text;
    }

    textDiv.appendChild(textContent);
    contentDiv.appendChild(textDiv);

    // Add suggestions
    if (msg.type === 'bot' && msg.suggestions) {
      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = 'flex flex-wrap gap-2 mt-1';
      
      msg.suggestions.forEach((suggestion: string) => {
        const btn = document.createElement('button');
        btn.className = 'text-[10px] px-2 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded hover:bg-emerald-500/20 hover:border-emerald-500/40 text-emerald-400 transition-all';
        btn.textContent = suggestion;
        btn.onclick = () => handleSend(suggestion);
        suggestionsDiv.appendChild(btn);
      });
      
      contentDiv.appendChild(suggestionsDiv);
    }

    messageDiv.appendChild(iconDiv);
    messageDiv.appendChild(contentDiv);
    
    return messageDiv;
  }

  // Add message to UI
  function addMessage(msg: any) {
    if (!messagesContainer) return;
    
    const messageEl = createMessageElement(msg);
    messagesContainer.appendChild(messageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Show typing indicator
  function showTypingIndicator() {
    if (!messagesContainer) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'message flex gap-3';
    typingDiv.innerHTML = `
      <div class="w-8 h-8 rounded bg-emerald-950/30 border border-emerald-500/30 text-emerald-400 flex items-center justify-center shrink-0">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
      </div>
      <div class="bg-emerald-900/10 p-3 rounded rounded-tl-none border border-emerald-500/20 flex items-center gap-1 typing-indicator">
        <span class="typing-dot"></span>
        <span class="typing-dot delay-75"></span>
        <span class="typing-dot delay-150"></span>
      </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
  }

  // Execute navigation actions
  function executeAction(action: string) {
    if (!action) return;
    
    const actions: Record<string, () => void> = {
      'SCROLL_PROJECTS': () => document.getElementById('projects')?.scrollIntoView({ behavior: 'smooth' }),
      'SCROLL_SKILLS': () => document.getElementById('skills')?.scrollIntoView({ behavior: 'smooth' }),
      'SCROLL_EXPERIENCE': () => document.getElementById('experience')?.scrollIntoView({ behavior: 'smooth' }),
      'SCROLL_CONTACT': () => document.getElementById('contact')?.scrollIntoView({ behavior: 'smooth' }),
      'SCROLL_ABOUT': () => document.getElementById('about')?.scrollIntoView({ behavior: 'smooth' }),
      'OPEN_GITHUB': () => window.open('https://github.com/sufyan2618', '_blank')
    };
    
    actions[action]?.();
  }

  // Handle send message
  async function handleSend(text?: string) {
    const message = text || chatInput?.value.trim();
    if (!message || isProcessing) return;

    // Add user message
    const userMsg = { id: Date.now(), type: 'user', text: message };
    messages.push(userMsg);
    addMessage(userMsg);

    if (chatInput) chatInput.value = '';
    isProcessing = true;
    if (sendBtn) sendBtn.setAttribute('disabled', 'true');
    
    showTypingIndicator();

    try {
      const apiUrl = chatBox?.dataset.apiUrl || '';
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: message }),
      });

      if (!response.ok) throw new Error('Network error');

      const data = await response.json();
      
      // Detect action from user query
      const lower = message.toLowerCase();
      let action = null;
      let suggestions = ['Show Projects', 'List Skills', 'Contact'];

      if (lower.includes('project') || lower.includes('work') || lower.includes('portfolio')) {
        action = 'SCROLL_PROJECTS';
        suggestions = ['Tell me about skills', 'Experience', 'Contact'];
      } else if (lower.includes('skill') || lower.includes('stack') || lower.includes('tech')) {
        action = 'SCROLL_SKILLS';
        suggestions = ['Show projects', 'Experience', 'Contact'];
      } else if (lower.includes('experience') || lower.includes('job') || lower.includes('history')) {
        action = 'SCROLL_EXPERIENCE';
        suggestions = ['Show projects', 'Skills', 'Contact'];
      } else if (lower.includes('contact') || lower.includes('email') || lower.includes('hire') || lower.includes('reach')) {
        action = 'SCROLL_CONTACT';
        suggestions = ['Show projects', 'Skills', 'Experience'];
      } else if (lower.includes('about')) {
        action = 'SCROLL_ABOUT';
        suggestions = ['Show projects', 'Skills', 'Contact'];
      } else if (lower.includes('github') || lower.includes('repo')) {
        action = 'OPEN_GITHUB';
        suggestions = ['Show projects', 'Back to site'];
      }

      hideTypingIndicator();

      const botMsg = {
        id: Date.now() + 1,
        type: 'bot',
        text: data.response_text || "I couldn't process that request. Please try again.",
        action,
        suggestions,
        isTyping: true
      };

      messages.push(botMsg);
      addMessage(botMsg);

      if (action) {
        setTimeout(() => executeAction(action), 1000);
      }
    } catch (error) {
      console.error('Error:', error);
      hideTypingIndicator();
      
      const errorMsg = {
        id: Date.now() + 1,
        type: 'bot',
        text: "Connection error. Unable to reach the neural network. Please try again.",
        suggestions: ['Try again', 'Show Projects', 'Contact'],
        isTyping: true
      };
      
      messages.push(errorMsg);
      addMessage(errorMsg);
    } finally {
      isProcessing = false;
      if (sendBtn) sendBtn.removeAttribute('disabled');
    }
  }

  // Event listeners
  trigger?.addEventListener('click', () => {
    isOpen = true;
    trigger.classList.add('hidden');
    chatBox?.classList.add('open');
    chatInput?.focus();
  });

  closeBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    isOpen = false;
    chatBox?.classList.remove('open');
    setTimeout(() => trigger?.classList.remove('hidden'), 300);
  });

  minimizeBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    isMinimized = !isMinimized;
    chatBox?.classList.toggle('minimized');
    
    // Update icon
    if (minimizeBtn) {
      minimizeBtn.innerHTML = isMinimized 
        ? '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>'
        : '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>';
    }
  });

  chatHeader?.addEventListener('click', () => {
    isMinimized = !isMinimized;
    chatBox?.classList.toggle('minimized');
  });

  sendBtn?.addEventListener('click', () => handleSend());

  chatInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleSend();
  });

  // Initialize with welcome message
  const welcomeMsg = {
    id: 1,
    type: 'bot',
    text: "SYSTEM ONLINE. I am the Neural Interface for this portfolio. I can navigate the site, explain projects, or just chat. How can I assist?",
    suggestions: ['Show Projects', 'My Skills', 'Contact Info'],
    isTyping: true
  };
  messages.push(welcomeMsg);
  
  // Add welcome message after a brief delay
  setTimeout(() => {
    addMessage(welcomeMsg);
  }, 500);
</script>
